---
title: "exploration"
author: "Jordan Boswell and Thuy Nguyen"
date: "2/26/2022"
output: html_document
---


```{r setup, include=FALSE}
knitr::opts_knit$set(echo = TRUE, root.dir = 'C:/Users/jbos1/Desktop/Projects/Kaggle/spaceship-titanic/data')
```

# Read data and format columns
```{r}
train <- read.csv("train.csv", na.strings=c("NA", ""))
test <- read.csv("test.csv", na.strings=c("NA", ""))
train$Train <- TRUE
test$Train <- FALSE
test$Transported <- NA
ship <- rbind(train, test)
create_base_columns <- function(df){
    df$GID <- as.integer(substr(df$PassengerId, 1,4))
    df$IID <- as.integer(substr(df$PassengerId,6,8))
    df$HomePlanet <- as.factor(df$HomePlanet)
    df$CryoSleep <- as.logical(df$CryoSleep)
    df$Destination <- as.factor(df$Destination)
    df$Age <- as.integer(df$Age)
    df$VIP <- as.logical(df$VIP)
    df
}
ship <- create_base_columns(ship)
ship$Transported <- as.logical(ship$Transported)
```

# Add Columns
## Deck/Side/Num
```{r}
updateDeckSideNum <- function (df) {
    df$Deck <- as.character(sapply(df$Cabin, function(x){ifelse(is.na(x), NA, strsplit(x, '/')[[1]][1])}))
    df$Num <- as.integer(sapply(df$Cabin, function(x){ifelse(is.na(x), NA, strsplit(x, '/')[[1]][2])}))
    df$Side <- as.character(sapply(df$Cabin, function(x){ifelse(is.na(x),NA, strsplit(x, '/')[[1]][3])}))
    df
}
ship <- updateDeckSideNum(ship)
```

## Spending
```{r}
updateSpending <- function(df){
  rsna <- is.na(df$RoomService)
  fcna <- is.na(df$FoodCourt)
  smna <- is.na(df$ShoppingMall)
  sna <- is.na(df$Spa)
  vrdna <- is.na(df$VRDeck)
  allna <- rsna & fcna & smna & sna & vrdna
  df$Spending <- ifelse(allna, NA, ifelse(rsna, 0, df$RoomService) + ifelse(fcna, 0, df$FoodCourt) + ifelse(smna, 0, df$ShoppingMall) + ifelse(sna, 0, df$Spa) + ifelse(vrdna, 0, df$VRDeck))
  df$HasSpent <- df$Spending > 0
  df
}
ship <- updateSpending(ship)
```

## Last Name
```{r}
ship$LastName <- sapply(ship$Name, function(x){strsplit(x,split = " ")}[[1]][2])
```

# EDA
## test$GID and train$GID are disjoint
```{r}
intersect(ship$GID[ship$Train], ship$GID[!ship$Train])
```

## CryoSleep iff 0 spending
### Evidence
```{r}
ftable(HasSpent~CryoSleep, data=ship)
```

### Update
```{r}
updateSpendingOfCryo <- function(df){
  df[df$CryoSleep %in% T, c("RoomService", "FoodCourt", "ShoppingMall", "Spa", "VRDeck")] <- 0
  df$CryoSleep[df$HasSpent %in% T] <- F
  df
}
ship <- updateSpendingOfCryo(ship)
```

## Young children (Age <= 12) don't spend money
### Evidence
```{r}
spending_mean <- sapply(split(ship$Spending, ship$Age), mean)
spending_25 <- sapply(split(ship$Spending, ship$Age), function(x){quantile(x, 0.25)})
spending_75 <- sapply(split(ship$Spending, ship$Age), function(x){quantile(x, 0.75)})
spending_length <- sapply(split(ship$Spending, ship$Age), length)

plot(names(spending_mean), spending_mean, main='Spending by Age', xlab='Age', ylab='Spending', col='red', type='l', lwd=2, ylim=c(0, max(spending_75)), xaxp=c(0, 80, 8))
lines(names(spending_mean), spending_25, col='light blue', lwd=2)
lines(names(spending_mean), spending_75, col='dark blue', lwd=2)
barplot(spending_length*15, add=T, space=0, col=rgb(.5,.5,.5,0.07), border=rgb(.5,.5,.5,0.22), names.arg=NA)
abline(v=12, lty=2)
legend(x='topleft', legend=c('75th percentile', 'mean', '25th percentile'), col=c('dark blue', 'red', 'light blue'), lwd=2)

table(as.factor(ifelse(ship$Age <= 12, 1, 0)), ship$HasSpent)
```
### Update
```{r}
updateSpendingOfChildren <- function(df){
 df[!is.na(df$Age) & df$Age <= 12, c("RoomService", "FoodCourt", "ShoppingMall", "Spa", "VRDeck")] <- 0
 df <- updateSpending(df)
 df
}
ship <- updateSpendingOfChildren(ship)
```

## Deck
### Does CryoSleep affect Deck?
#### Distribution of CryoSleep
```{r}
signif(table(ship$Deck[!is.na(ship$CryoSleep) & !is.na(ship$Deck) & ship$CryoSleep == T]) / sum(!is.na(ship$CryoSleep) & !is.na(ship$Deck) & ship$CryoSleep == T) * 100, 4)
```
#### Per-deck percentage of CryoSleep
```{r}
signif(table(ship$Deck[!is.na(ship$CryoSleep) & !is.na(ship$Deck) & ship$CryoSleep == T]) / tapply(ship$Deck, ship$Deck, FUN=length)[-8] * 100, 4)
```

### Exploring Num within each Deck
```{r}
# todo - Change to multi-dist plot (e.g. violin)
for (deck in sort(unique(ship$Deck))){
    if (is.na(deck)) next
    hist(ship$Num[!is.na(ship$Deck) & ship$Deck == deck], main=deck)
}
```
### Room Size
```{r}
# Average number of people per room (for each deck)
tapply(ship$Num, ship$Deck, function(x){length(x)/length(unique(x))})

tapply(ship$Age, ship$Deck, summary)
```

## Group
### Create Separate Group Dataset
```{r}
splits <- split(ship, ship$GID)
ship_groups <- data.frame(t(
    sapply(splits, function(x){c(
        GID = x$GID[1],
        GroupSize = nrow(x),
        GroupNumCabinsNA = nrow(subset(x, is.na(Cabin))),
        GroupNumCabins = ifelse(nrow(x) == 1, 1, length(unique(x$Cabin[!is.na(x$Cabin)]))),
        GroupNumTransported = sum(x$Transported, na.rm=T),
        GroupNumNotTransported = sum(x$Transported==FALSE, na.rm=T),
        GroupTransportedPct = sum(x$Transported == T, na.rm=T)/sum(!is.na(x$Transported)),
        GroupCabinMode = ifelse(sum(is.na(x$Cabin)) == nrow(x), NA, names(sort(table(x$Cabin), decreasing=T))[1]),
        GroupNumInCabinMode = ifelse(sum(is.na(x$Cabin)) == nrow(x), NA, sum(!is.na(x$Cabin) & x$Cabin == names(sort(table(x$Cabin), decreasing=T))[1])),
        GroupNumHomePlanets = ifelse(nrow(x) == 1, 1, length(unique(x$HomePlanet[!is.na(x$HomePlanet)]))),
        GroupNumDestinations = ifelse(nrow(x) == 1, 1, length(unique(x$Destination[!is.na(x$Destination)]))),
        GroupHomePlanetMode = ifelse(sum(is.na(x$HomePlanet)) == nrow(x), NA, names(sort(table(x$HomePlanet), decreasing=T))[1]),
        GroupDestinationMode = ifelse(sum(is.na(x$Destination)) == nrow(x), NA, names(sort(table(x$Destination), decreasing=T))[1])
    )})
))
ship_groups$GID <- as.integer(ship_groups$GID)
ship_groups$GroupSize <- as.integer(ship_groups$GroupSize)
ship_groups$GroupNumCabinsNA <- as.integer(ship_groups$GroupNumCabinsNA)
ship_groups$GroupNumCabins <- as.integer(ship_groups$GroupNumCabins)
ship_groups$GroupNumTransported <- as.integer(ship_groups$GroupNumTransported)
ship_groups$GroupNumNotTransported <- as.integer(ship_groups$GroupNumNotTransported)
ship_groups$GroupNumInCabinMode <- as.integer(ship_groups$GroupNumInCabinMode)
ship_groups$GroupNumHomePlanets <- as.integer(ship_groups$GroupNumHomePlanets)
ship_groups$GroupNumDestinations <- as.integer(ship_groups$GroupNumDestinations)
rm(splits)
```

### Add Group Columns
```{r}
ship <- merge(ship, ship_groups, by='GID', all.x=T) 
```

## Cabin
### Impute Cabin Based on Group Cabin Mode
#### Evidence
*If a person has a group that is all in the same cabin, then should we expect that person to also be in that same cabin?*
```{r}
for (i in 2:max(ship_groups$GroupSize)){
    print(paste0("All Non NA Same Cabin (For Groups With Non-NA Size ", i, "):"))
    s <- ship_groups[ship_groups$GroupSize - ship_groups$GroupNumCabinsNA == i & (ship_groups$GroupNumCabins == 1 | (ship_groups$GroupNumCabins == 2 & ship_groups$GroupSize - (ship_groups$GroupNumInCabinMode + ship_groups$GroupNumCabinsNA) == 1)),]
    st <- table(s$GroupNumInCabinMode == s$GroupSize - s$GroupNumCabinsNA)
    print(st)
    num_true <- ifelse('TRUE' %in% names(st), st[['TRUE']], 0)
    num_false <- ifelse('FALSE' %in% names(st), st[['FALSE']], 0)
    p_same <- i * num_true / (i*num_true + num_false)
    print(paste0('Probability of same cabin: ', round(p_same,2)))
    print("-------------------------------------------")
}
rm(s)
```

#### Update
```{r}
ship$Cabin[is.na(ship$Cabin) & !is.na(ship$GroupCabinMode)] <- ship$GroupCabinMode[is.na(ship$Cabin) & !is.na(ship$GroupCabinMode)]
ship <- updateDeckSideNum(ship)
```

### Create Separate Cabin Dataset
```{r}
splits <- split(ship[!is.na(ship$Cabin), ], ship$Cabin[!is.na(ship$Cabin)])
ship_cabins <- data.frame(t(
    sapply(splits, function(x){c(
        CabinSize = length(x$PassengerId),
        Cabin = x$Cabin[1],
        Deck = x$Deck[1],
        Side = x$Side[1],
        Num = x$Num[1],
        CabinNumTransported = sum(x$Transported, na.rm=T),
        CabinNumNotTransported = sum(x$Transported==FALSE, na.rm=T),
        CabinTransportedPct = ifelse(sum(!is.na(x$Transported) == 0), NA, sum(x$Transported == T, na.rm=T)/sum(!is.na(x$Transported))),
        CabinNumCryo = sum(x$CryoSleep, na.rm=T)
    )})
))
ship_cabins$CabinSize <- as.integer(ship_cabins$CabinSize)
ship_cabins$Num <- as.integer(ship_cabins$Num)
ship_cabins$CabinNumTransported <- as.integer(ship_cabins$CabinNumTransported)
ship_cabins$CabinNumNotTransported <- as.integer(ship_cabins$CabinNumNotTransported)
ship_cabins$CabinTransportedPct <- as.numeric(ship_cabins$CabinTransportedPct)
ship_cabins$CabinNumCryo <- as.integer(ship_cabins$CabinNumCryo)
ship_cabins$SideNeighbors <- as.integer(NA)
ship_cabins$SideNeighborsTransported <- as.integer(NA)
ship_cabins$SideNeighborsTransportedPct <- as.numeric(NA)
ship_cabins$FrontNeighbors <- as.integer(NA)
ship_cabins$FrontNeighborsTransported <- as.integer(NA)
ship_cabins$FrontNeighborsTransportedPct <- as.numeric(NA)
ship_cabins$BackNeighbors <- as.integer(NA)
ship_cabins$BackNeighborsTransported <- as.integer(NA)
ship_cabins$BackNeighborsTransportedPct <- as.numeric(NA)
ship_cabins$DiagFrontNeighbors <- as.integer(NA)
ship_cabins$DiagFrontNeighborsTransported <- as.integer(NA)
ship_cabins$DiagFrontNeighborsTransportedPct <- as.numeric(NA)
ship_cabins$DiagBackNeighbors <- as.integer(NA)
ship_cabins$DiagBackNeighborsTransported <- as.integer(NA)
ship_cabins$DiagBackNeighborsTransportedPct <- as.numeric(NA)
for (i in 1:nrow(ship_cabins)){
    side_neighbor <- subset(ship_cabins, Deck == Deck[i] & Num == Num[i] & Side != Side[i])
    back_neighbor <- subset(ship_cabins, Deck == Deck[i] & Num == Num[i]-1 & Side == Side[i])
    front_neighbor <- subset(ship_cabins, Deck == Deck[i] & Num == Num[i]+1 & Side == Side[i])
    diag_back_neighbor <- subset(ship_cabins, Deck == Deck[i] & Num == Num[i]-1 & Side != Side[i])
    diag_front_neighbor <- subset(ship_cabins, Deck == Deck[i] & Num == Num[i]+1 & Side != Side[i])
    ship_cabins$SideNeighbors[i] <- ifelse(nrow(side_neighbor) == 0, 0, side_neighbor$CabinNumTransported + side_neighbor$CabinNumNotTransported)
    ship_cabins$SideNeighborsTransported[i] <- ifelse(nrow(side_neighbor) == 0, 0, side_neighbor$CabinNumTransported)
    ship_cabins$SideNeighborsTransportedPct[i] <- ifelse(nrow(side_neighbor) == 0, 0, side_neighbor$CabinTransportedPct)
    ship_cabins$FrontNeighbors[i] <- ifelse(nrow(front_neighbor) == 0, 0, front_neighbor$CabinNumTransported + front_neighbor$CabinNumNotTransported)
    ship_cabins$FrontNeighborsTransported[i] <- ifelse(nrow(front_neighbor) == 0, 0, front_neighbor$CabinNumTransported)
    ship_cabins$FrontNeighborsTransportedPct[i] <- ifelse(nrow(front_neighbor) == 0, 0, front_neighbor$CabinTransportedPct)
    ship_cabins$BackNeighbors[i] <- ifelse(nrow(back_neighbor) == 0, 0, back_neighbor$CabinNumTransported + back_neighbor$CabinNumNotTransported)
    ship_cabins$BackNeighborsTransported[i] <- ifelse(nrow(back_neighbor) == 0, 0, back_neighbor$CabinNumTransported)
    ship_cabins$BackNeighborsTransportedPct[i] <- ifelse(nrow(back_neighbor) == 0, 0, back_neighbor$CabinTransportedPct)
    ship_cabins$DiagFrontNeighbors[i] <- ifelse(nrow(diag_front_neighbor) == 0, 0, diag_front_neighbor$CabinNumTransported + diag_front_neighbor$CabinNumNotTransported)
    ship_cabins$DiagFrontNeighborsTransported[i] <- ifelse(nrow(diag_front_neighbor) == 0, 0, diag_front_neighbor$CabinNumTransported)
    ship_cabins$DiagFrontNeighborsTransportedPct[i] <- ifelse(nrow(diag_front_neighbor) == 0, 0, diag_front_neighbor$CabinTransportedPct)
    ship_cabins$DiagBackNeighbors[i] <- ifelse(nrow(diag_back_neighbor) == 0, 0, diag_back_neighbor$CabinNumTransported + diag_back_neighbor$CabinNumNotTransported)
    ship_cabins$DiagBackNeighborsTransported[i] <- ifelse(nrow(diag_back_neighbor) == 0, 0, diag_back_neighbor$CabinNumTransported)
    ship_cabins$DiagBackNeighborsTransportedPct[i] <- ifelse(nrow(diag_back_neighbor) == 0, 0, diag_back_neighbor$CabinTransportedPct)
}
rm(splits, front_neighbor, side_neighbor, back_neighbor, diag_front_neighbor, diag_back_neighbor)
```

### Add Cabin Columns
```{r}
ship <- merge(ship, ship_cabins, by=c('Cabin', 'Side', 'Deck', 'Num'), all.x=T)
```

### Percentage of Cabins Having the Same CryoSleep

```{r}
count <- 0
total <- 0
for (i in unique(ship$Cabin[!is.na(ship$Cabin)])){
  g <- ship[!is.na(ship$CryoSleep) & !is.na(ship$Cabin) & ship$Cabin == i, ]
  if (nrow(g) <= 1) next
  if (length(unique(g$CryoSleep)) == 1) {
    count <- count + 1
    total <- total + 1
  }
  else if (length(unique(g$CryoSleep)) == 2) {
    total <- total + 1
  }
}
print(paste0(count, " / ", total, " = ", round(count/total, 2)))
rm(g)
```

### Groups Share the Same HomePlanet (But Not Destination)
#### Evidence
```{r}
table(ship_groups$GroupNumHomePlanets)
table(ship_groups$GroupNumDestinations)
```

#### Update
```{r}
for (i in 1:nrow(ship)){
    if (is.na(ship$HomePlanet[i]) && !is.na(ship$GroupHomePlanetMode[i])){
        ship$HomePlanet[i] <- ship$GroupHomePlanetMode[i]
    }
}
```

# Write ship to CSV
```{r}
write.csv(ship, 'ship.csv')
```