---
title: "exploration"
author: "Jordan Boswell and Thuy Nguyen"
date: "2/26/2022"
output: html_document
---


```{r}
library(randomForest)
library(rpart)
library(rpart.plot)
```


# Read data and format columns
```{r}
train <- read.csv("train.csv", na.strings=c("NA", ""))
test <- read.csv("test.csv", na.strings=c("NA", ""))
train$Train <- TRUE
test$Train <- FALSE
test$Transported <- NA
ship <- rbind(train, test)

create_base_columns <- function(df){
    df$GID <- as.integer(substr(df$PassengerId, 1,4))
    
    df$IID <- as.integer(substr(df$PassengerId,6,8))
    
    df$GroupSize <- sapply(df$GID, function(x){sum(df$GID == x)})
    
    df$HomePlanet <- as.factor(df$HomePlanet)
    
    df$CryoSleep <- as.logical(df$CryoSleep)
    
    df$Deck <- as.character(mapply(function(x,y){if(is.na(x)){NA}else{substr(x,y[2],y[3]-2)}},
                          df$Cabin,
                          regexec("(.*?)/(.*?)/(.*)", df$Cabin)))
    df$Num <- as.integer(mapply(function(x,y){if(is.na(x)){NA}else{substr(x,y[3],y[4]-2)}},
                          df$Cabin,
                          regexec("(.*?)/(.*?)/(.*)", df$Cabin)))
    df$Side <- as.character(mapply(function(x,y){if(is.na(x)){NA}else{substr(x,y[4],nchar(x))}},
                          df$Cabin,
                          regexec("(.*?)/(.*?)/(.*)", df$Cabin)))
    #df$Cabin <- sapply(df$Cabin, function(x){if (x=="") NA else x})
    
    df$Destination <- as.factor(df$Destination)
    
    df$Age <- as.integer(df$Age)
    
    df$VIP <- as.logical(df$VIP)
    
    df
}

ship <- create_base_columns(ship)

ship$Transported <- as.logical(ship$Transported)

updateSpending <- function(df){
  rsna <- is.na(df$RoomService)
  fcna <- is.na(df$FoodCourt)
  smna <- is.na(df$ShoppingMall)
  sna <- is.na(df$Spa)
  vrdna <- is.na(df$VRDeck)
  allna <- rsna & fcna & smna & sna & vrdna
  df$Spending <- ifelse(allna, NA, ifelse(rsna, 0, df$RoomService) + ifelse(fcna, 0, df$FoodCourt) + ifelse(smna, 0, df$ShoppingMall) + ifelse(sna, 0, df$Spa) + ifelse(vrdna, 0, df$VRDeck))
  df$HasSpent <- df$Spending > 0
  df
}
ship <- updateSpending(ship)
```

# Notes
## test$GID and train$GID are disjoint
```{r}
intersect(ship$GID[ship$Train], ship$GID[!ship$Train])
```


# Fixing missing data
## Cryosleep implies 0 spending
## <=> spending implies not Cryosleep
### Evidence
```{r}
ftable(HasSpent~CryoSleep, data=ship)
```
### Update
```{r}
updateSpendingOfCryo <- function(df){
  df[df$CryoSleep %in% T, c("RoomService", "FoodCourt", "ShoppingMall", "Spa", "VRDeck")] <- 0
  df <- updateSpending(df)
  df$Cryosleep[df$HasSpent %in% T] <- F
  df
}
ship <- updateSpendingOfCryo(ship)
```

## Young children (Age <= 12) don't spend money
### Evidence
```{r}
spending_mean <- sapply(split(ship$Spending, ship$Age), mean)
spending_25 <- sapply(split(ship$Spending, ship$Age), function(x){quantile(x, 0.25)})
spending_75 <- sapply(split(ship$Spending, ship$Age), function(x){quantile(x, 0.75)})
spending_length <- sapply(split(ship$Spending, ship$Age), length)

plot(names(spending_mean), spending_mean, main='Spending by Age', xlab='Age', ylab='Spending', col='red', type='l', lwd=2, ylim=c(0, max(spending_75)), xaxp=c(0, 80, 8))
lines(names(spending_mean), spending_25, col='light blue', lwd=2)
lines(names(spending_mean), spending_75, col='dark blue', lwd=2)
barplot(spending_length*15, add=T, space=0, col=rgb(.5,.5,.5,0.07), border=rgb(.5,.5,.5,0.22), names.arg=NA)
abline(v=12, lty=2)
legend(x='topleft', legend=c('75th percentile', 'mean', '25th percentile'), col=c('dark blue', 'red', 'light blue'), lwd=2)
```
### Update
```{r}
updateSpendingOfChildren <- function(df){
 df[!is.na(df$Age) & df$Age <= 12, c("RoomService", "FoodCourt", "ShoppingMall", "Spa", "VRDeck")] <- 0
 df <- updateSpending(df)
 df
}
ship <- updateSpendingOfChildren(ship)
```

## Does Cryosleep affect Cabin?
```{r}
signif(table(ship$Deck[!is.na(ship$CryoSleep) & !is.na(ship$Deck) & ship$CryoSleep == T]) / sum(!is.na(ship$CryoSleep) & !is.na(ship$Deck) & ship$CryoSleep == T) * 100, 4)

signif(table(ship$Deck[!is.na(ship$CryoSleep) & !is.na(ship$Deck) & ship$CryoSleep == T]) / tapply(ship$Deck, ship$Deck, FUN=length)[-8] * 100, 4)
```


## Exploring Num
```{r}
for (deck in sort(unique(ship$Deck))){
    if (is.na(deck)) next
    hist(ship$Num[!is.na(ship$Deck) & ship$Deck == deck], main=deck)
}
```

## Hypothesis: People in the same group of at least 2 members live in the same Deck for cabins A, B, C
### Create Useful Columns
```{r}
updateOthersCabins <- function(df){
    decks <- c("A", "B", "C", "D", "E", "F", "G", "T")

    for (i in 1:nrow(df)){
      group_members <- subset(df, GID == df$GID[i] & IID != df$IID[i])
      for (deck in decks) {
        df[i, paste0("Others", deck)] <- sum(!is.na(group_members$Deck) & group_members$Deck == deck)
      }
      
      df$OthersSameCabin[i] <- ifelse(is.na(df$Cabin[i]),
                               NA,
                               sum(!is.na(group_members$Cabin) & group_members$Cabin == df$Cabin[i]))
      df$OthersNACabin[i] <- sum(is.na(group_members$Cabin))
      df$OthersTransported[i] <- sum(group_members$Transported)
    }
    df
}

ship <- updateOthersCabins(ship)
```

```{r}
gids <- unique(ship$GID[ship$GroupSize > 1])
ship_groups <- data.frame(GID = gids, AllNonNASameCabin = NA, SharedCabin = NA)
ship_groups$UniqueCabins <- 0
ship_groups$NumInSecondCabin <- NA
ship_groups$SharedCabin <- NA
ship_groups$HomePlanet <- factor(NA, levels=c("Earth", "Europa", "Mars"))
for (i in 1:nrow(ship_groups)){
    gid <- gids[i]
    the_group <- subset(ship, GID == gid)
    ship_groups$CabinNA[i] <- sum(is.na(the_group$Cabin))
    ship_groups$Size[i] <- nrow(the_group)
    home_planets <- the_group$HomePlanet[!is.na(the_group$HomePlanet)]
    ship_groups$HomePlanets[i] <- length(unique(home_planets))
    ship_groups$HomePlanet[i] <- home_planets[1]
    ship_groups$Destinations[i] <- length(unique(the_group$Destination[!is.na(the_group$Destination)]))
    if (sum(is.na(the_group$Cabin)) == length(the_group))
        ship_groups$AllNonNASameCabin[i] <- NA
    else{
        unique_cabins <- unique(the_group$Cabin[!is.na(the_group$Cabin)])
        ship_groups$UniqueCabins[i] <- length(unique_cabins)
        ship_groups$AllNonNASameCabin[i] <- length(unique_cabins) == 1
        if (ship_groups$UniqueCabins[i] == 1) {
            ship_groups$SharedCabin[i] <- unique_cabins[1]
        }
        else if (ship_groups$UniqueCabins[i] == 2) {
            num1 <- 0
            num2 <- 0
            for (cabin in the_group$Cabin) {
                if (is.na(cabin)) next
                if (cabin == unique_cabins[1]) num1 <- num1 + 1
                else num2 <- num2 + 1
            }
            ship_groups$NumInSecondCabin[i] <- min(num1, num2)
        }
        else if (ship_groups$UniqueCabins[i] == 3){
            num1 <- 0
            num2 <- 0
            num3 <- 0
            for (cabin in the_group$Cabin) {
                if (is.na(cabin)) next
                if (cabin == unique_cabins[1]) num1 <- num1 + 1
                else if (cabin == unique_cabins[2]) num2 <- num2 + 1
                else num3 <- num3 + 1
            }
            ship_groups$NumInSecondCabin[i] <- sort(c(num1, num2, num3))[2]
        }
        ship_groups$SharedCabin[i] <- ifelse(length(unique_cabins) == 1, unique_cabins[1], NA)
    }
}

rm(the_group)
rm(home_planets)
```

## Groups share the same home planet (but not destination)
## Evidence
```{r}
table(ship_groups$HomePlanets)
table(ship_groups$Destinations)
```

## Update
```{r}
for (i in 1:nrow(ship)){
    if (is.na(ship$HomePlanet[i]) && ship$GroupSize[i] > 1){
        ship$HomePlanet[i] <- ship_groups$HomePlanet[ship_groups$GID == ship$GID[i]]
    }
}
```


```{r}
for (i in 2:max(ship_groups$Size)){
    print(paste0("All Non NA Same Cabin (For Groups With Non-NA Size ", i, "):"))
    print(table(ship_groups$AllNonNASameCabin[ship_groups$Size - ship_groups$CabinNA == i & (ship_groups$UniqueCabins == 1 | (ship_groups$UniqueCabins == 2 & ship_groups$NumInSecondCabin == 1))]))
    print("-------------------------------------------")
}

```



# Last name

```{r}
ship$LastName <- sapply(ship$Name, function(x){strsplit(x,split = " ")}[[1]][2])
```


#  Same last name, same group: for each deck

```{r}
#for(j in C("A","B","C", "D","E", "F","G", "T")){
  deck <- subset(ship, Deck=="A")
  for(i in unique(deck$LastName)){
    Name <- subset(deck, LastName == i)
    if (nrow(Name) ==1)
      next
    else (length(unique(Name$GID)) >1)
      print(Name$GID)
  }
#}
Name


```
# Same last name,same group !-> same cabin

```{r}
data <- ship %>% filter(!is.na(LastName) & !is.na(Cabin))

for(i in unique(data$LastName)){
  Name <- subset(data, LastName == i)
  if (nrow(Name) ==1)
    next
  
  else if (length(unique(Name$GID)>1)) 
     {
    for (j in unique(Name$GID)){
      gid <- subset(Name, GID ==j)
     
      if (nrow(gid) ==1)
        next
     
      else if (length(unique(gid$Cabin)) >1)
    
          print(gid$GID)
    }
  }
}
```

## Heat-maps

```{r}
heatarray <- function(c1, c2){
  train <- subset(ship, Train == T)
  c1 <- as.factor(train[[c1]])
  c2 <- as.factor(train[[c2]])
  m <- matrix(NA, nrow = length(levels(c1)), ncol = length(levels(c2)))
  rownames(m) <- levels(c1)
  colnames(m) <- levels(c2)
  for (i in 1:nrow(m)){
    for (j in 1:ncol(m)){
      m[i,j] <- round(sum(train$Transported[c1==levels(c1)[i] & c2==levels(c2)[j]], na.rm=T) / length(train$Transported[!is.na(c1) & !is.na(c2) & c1==levels(c1)[i] & c2==levels(c2)[j]]), 2)
    }
  }
  return(m)
}


```


## percentage of group/lastname/family having the same Cryosleep value

```{r}
count <- 0
total <- 0
for (i in unique(ship$GID)){
  g <- ship[!is.na(ship$CryoSleep) & ship$GID == i & ship$GroupSize > 1, ]
  if (length(unique(g$CryoSleep)) == 1) {
    count <- count + 1
    total <- total + 1
  }
  else if (length(unique(g$CryoSleep)) == 2) {
    total <- total + 1
  }
}
print(paste0(count, " / ", total, " = ", round(count/total, 2)))
```

```{r}
count <- 0
total <- 0
for (i in unique(ship$LastName)){
  g <- ship[!is.na(ship$CryoSleep) & !is.na(ship$LastName) & ship$LastName == i, ]
  if (length(unique(g$CryoSleep)) == 1) {
    count <- count + 1
    total <- total + 1
  }
  else if (length(unique(g$CryoSleep)) == 2) {
    total <- total + 1
  }
}
print(paste0(count, " / ", total, " = ", round(count/total, 2)))
```

```{r}
count <- 0
total <- 0
for (i in unique(ship$GID)){
  g <- ship[!is.na(ship$CryoSleep) & ship$GID == i & ship$GroupSize > 1, ]
  for (j in unique(g$LastName[!is.na(g$LastName)])){
    g2 <- g[!is.na(g$LastName) & g$LastName == j, ]
    if (length(unique(g2$CryoSleep)) == 1) {
      count <- count + 1
      total <- total + 1
    }
    else if (length(unique(g2$CryoSleep)) == 2) {
      total <- total + 1
    }
  }
}
print(paste0(count, " / ", total, " = ", round(count/total, 2)))
```

## percentage of cabins having the same cryosleep

```{r}
count <- 0
total <- 0
for (i in unique(ship$Cabin[!is.na(ship$Cabin)])){
  g <- ship[!is.na(ship$CryoSleep) & !is.na(ship$Cabin) & ship$Cabin == i, ]
  if (nrow(g) <= 1) next
  if (length(unique(g$CryoSleep)) == 1) {
    count <- count + 1
    total <- total + 1
  }
  else if (length(unique(g$CryoSleep)) == 2) {
    total <- total + 1
  }
}
print(paste0(count, " / ", total, " = ", round(count/total, 2)))
```

```{r}
count <- 0
total <- 0
for (i in unique(ship$Deck[!is.na(ship$Deck)])){
  g <- ship[!is.na(ship$CryoSleep) & !is.na(ship$Deck) & ship$Deck == i, ]
  if (nrow(g) <= 1) next
  if (length(unique(g$CryoSleep)) == 1) {
    count <- count + 1
    total <- total + 1
  }
  else if (length(unique(g$CryoSleep)) == 2) {
    total <- total + 1
  }
}
print(paste0(count, " / ", total, " = ", round(count/total, 2)))
```

```{r}
library(hexbin)
train <- subset(ship, Train==T)
hb <- hexbin(train$Spa, train$FoodCourt, IDs=T)
hvp <- plot(hb, colramp=function(n, beg=1, end=92){LinGray(n, 1, 1)}, border='white', clip="off")
pushHexport(hvp$plot.vp)
ht <- hexTapply(hb, train$Transported, FUN=function(x){(sum(x)/length(x))*100})
hb@count <- as.integer(ht)
grid.hexagons(hb, colramp=LinGray, border='white')
```


# Shiny
```{r}
library(shiny)
library(hexbin)

set.seed(1)

shipDecks <- split(ship, ship$Deck)

buildTab <- function(deck) {
    tabPanel(
        paste0("Deck ",  deck),
        fluidRow(plotOutput(paste0("Tree", deck))),
        fluidRow(
            column(
                width=2,
                inputPanel(
                    radioButtons(
                        paste0('HexXName', deck),
                        label = 'x variable',
                        choices = c('RoomService', 'FoodCourt', 'ShoppingMall', 'Spa', 'VRDeck'),
                        selected = 'FoodCourt'
                    ),
                    radioButtons(
                        paste0('HexYName', deck),
                        label = 'y variable',
                        choices = c('RoomService', 'FoodCourt', 'ShoppingMall', 'Spa', 'VRDeck'),
                        selected = 'Spa'
                    ),
                    sliderInput(
                        paste0('HexLim', deck),
                        label='Spending range',
                        min = 0,
                        max = max(ship$Spending[ship$Deck == deck], na.rm=T),
                        value = c(0, max(ship$Spending[ship$Deck == deck], na.rm=T))
                    )
                )
            
            ),
            column(
                width=5,
                plotOutput(paste0('HexPlot1', deck))
            ),
            column(
                width=5,
                plotOutput(paste0('HexPlot2', deck))
            )
        )
    )
}

renderSidebar <- function(deck) {
    paste0("<p><strong>Passengers: </strong>", nrow(shipDecks[[deck]]), "</p>")
}

plotDt <- function(deck) {
    rpart.plot(
            rpart(Transported~., data=shipDecks[[deck]][, -c(1, 4, 13, 15, 16, 17, 19, 20, 24)])
        )
}

plotHex <- function(deck, xName, yName, spendLim, transported=F) {
    train <- subset(ship, Deck == deck & Train==T & Spending >= spendLim[1] & Spending <= spendLim[2])
    hb <- hexbin(train[[xName]], train[[yName]], IDs=T)
    if (transported == T) {
        hvp <- plot(hb, colramp=function(n, beg=1, end=92){LinGray(n, 1, 1)}, border='white', clip="off")
        pushHexport(hvp$plot.vp)
        ht <- hexTapply(hb, train$Transported, FUN=function(x){(sum(x)/length(x))*100})
        hb@count <- as.integer(ht)
        grid.hexagons(hb, colramp=LinGray, border='white')
    }
    else {
        plot(hb, colramp=LinGray, border='white', clip="off")
    }
}

ui <- navbarPage(
    title="Spaceship Titanic",
    buildTab("T"),
    buildTab("A"),
    buildTab("B"),
    buildTab("C"),
    buildTab("D"),
    buildTab("E"),
    buildTab("F"),
    buildTab("G")
)

server <- function(input, output) {
    output$SidebarT <- renderText(renderSidebar("T"))
    #output$TreeT <- renderPlot({plotDt("T")})
    #output$HexPlot1T <- renderPlot({plotHex('T', input$HexXNameT, input$HexYNameT, input$HexLimT)})
    #output$HexPlot2T <- renderPlot({plotHex('T', input$HexXNameT, input$HexYNameT, input$HexLimT, T)})
    output$SidebarA <- renderText(renderSidebar("A"))
    output$TreeA <- renderPlot({plotDt("A")})
    output$HexPlot1A <- renderPlot({plotHex('A', input$HexXNameA, input$HexYNameA, input$HexLimA)})
    output$HexPlot2A <- renderPlot({plotHex('A', input$HexXNameA, input$HexYNameA, input$HexLimA, T)})
    output$SidebarB <- renderText(renderSidebar("B"))
    output$TreeB <- renderPlot({plotDt("B")})
    output$HexPlot1B <- renderPlot({plotHex('B', input$HexXNameB, input$HexYNameB, input$HexLimB)})
    output$HexPlot2B <- renderPlot({plotHex('B', input$HexXNameB, input$HexYNameB, input$HexLimB, T)})
    output$SidebarC <- renderText(renderSidebar("C"))
    output$TreeC <- renderPlot({plotDt("C")})
    output$HexPlot1C <- renderPlot({plotHex('C', input$HexXNameC, input$HexYNameC, input$HexLimC)})
    output$HexPlot2C <- renderPlot({plotHex('C', input$HexXNameC, input$HexYNameC, input$HexLimC, T)})
    output$SidebarD <- renderText(renderSidebar("D"))
    output$TreeD <- renderPlot({plotDt("D")})
    output$HexPlot1D <- renderPlot({plotHex('D', input$HexXNameD, input$HexYNameD, input$HexLimD)})
    output$HexPlot2D <- renderPlot({plotHex('D', input$HexXNameD, input$HexYNameD, input$HexLimD, T)})
    output$SidebarE <- renderText(renderSidebar("E"))
    output$TreeE <- renderPlot({plotDt("E")})
    output$HexPlot1E <- renderPlot({plotHex('E', input$HexXNameE, input$HexYNameE, input$HexLimE)})
    output$HexPlot2E <- renderPlot({plotHex('E', input$HexXNameE, input$HexYNameE, input$HexLimE, T)})
    output$SidebarF <- renderText(renderSidebar("F"))
    output$TreeF <- renderPlot({plotDt("F")})
    output$HexPlot1F <- renderPlot({plotHex('F', input$HexXNameF, input$HexYNameF, input$HexLimF)})
    output$HexPlot2F <- renderPlot({plotHex('F', input$HexXNameF, input$HexYNameF, input$HexLimF, T)})
    output$SidebarG <- renderText(renderSidebar("G"))
    output$TreeG <- renderPlot({plotDt("G")})
    output$HexPlot1G <- renderPlot({plotHex('G', input$HexXNameG, input$HexYNameG, input$HexLimG)})
    output$HexPlot2G <- renderPlot({plotHex('G', input$HexXNameG, input$HexYNameG, input$HexLimG, T)})
}

shinyApp(ui, server)
```



# Models
## Read in Test and Modify
```{r}
test <- read.csv("test.csv", na.strings=c("NA", ""))
test <- create_base_columns(test)
test <- updateSpending(test)
test$HomePlanet[test$HomePlanet==""] <- NA
test$Destination[test$Destination==""] <- NA
test$Name[test$Name==""] <- NA
test <- updateSpendingOfCryo(test)
test <- updateSpendingOfChildren(test)
test <- updateOthersCabins(test)
```

## Imputation
```{r}
library(missForest)

variables <- c("HomePlanet", "CryoSleep", "Destination", "Age", "VIP", "GroupSize", "Deck", "Side", "Spending")

test$CryoSleep <- as.factor(test$CryoSleep)
test$Age <- as.numeric(test$Age)
test$Deck <- as.factor(test$Deck)
test$VIP <- as.factor(test$VIP)
test$GroupSize <- as.numeric(test$GroupSize)
test$Side <- as.factor(test$Side)

test[, variables] <- missForest(test[, variables])$ximp
test <- updateSpending(test)
test <- updateSpendingOfCryo(test)
test <- updateSpendingOfChildren(test)
test <- updateOthersCabins(test)

ship$CryoSleep <- as.factor(ship$CryoSleep)
ship$Age <- as.numeric(ship$Age)
ship$Deck <- as.factor(ship$Deck)
ship$VIP <- as.factor(ship$VIP)
ship$GroupSize <- as.numeric(ship$GroupSize)
ship$Side <- as.factor(ship$Side)

ship[, variables] <- missForest(ship[, variables])$ximp
ship <- updateSpending(ship)
ship <- updateSpendingOfCryo(ship)
ship <- updateSpendingOfChildren(ship)
ship <- updateOthersCabins(ship)
```




# Predict Cryoshleep

```{r}
newdat <- ship[is.na(ship$CryoSleep),]

g1 <-glm(as.factor(CryoSleep)~ GroupSize + RoomService+ FoodCourt+ ShoppingMall+Spa+VRDeck+as.factor(VIP)+Age+Deck+Num+Side, data= ship,na.action = "na.omit", family = "binomial")
pred <- predict(g1, newdata= newdat, type = "response")>=0.5
pred

```

## decision tree

```{r}
rpart.plot(rpart(Transported~HomePlanet+CryoSleep+Destination+Age+VIP+Spending+GroupSize+Deck+Num+Side, data= ship, control=rpart.control(cp=0.005)))
```



## GLMS

```{r}
glm1 <-glm(Transported~ Age+Spa+Spending+OthersTransported+as.factor(HomePlanet)+as.factor(VIP)+GroupSize +VRDeck+HasSpent +CryoSleep+RoomService+FoodCourt +as.factor(Deck)+Destination+ShoppingMall+as.numeric(Num)+as.factor(Side), data = ship, family = "binomial")




pred <- predict(glm1, newdata = test,type = "response" )>=0.5

pred <- ifelse(is.na(pred), TRUE, pred)

pred <- ifelse(pred =="TRUE", "True", "False")

write.csv(data.frame("PassengerId" = test$PassengerId, "Transported" = pred), row.names = FALSE,  quote = FALSE, file = "submission.csv")
```


## Random Forest
```{r}
ship$Transported <- as.factor(ship$Transported)
rf <- randomForest(Transported~., data=ship[, c(variables, "Transported")])
predictions <- predict(rf, newdata=test)
predictions <- ifelse(predictions == "TRUE", "True", "False")
write.csv(list(PassengerId=test$PassengerId, Transported=predictions), file="submission.csv", row.names=F, quote=F)
```