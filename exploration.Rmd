---
title: "exploration"
author: "Jordan Boswell and Thuy Nguyen"
date: "2/26/2022"
output: html_document
---


```{r}
library(rigr)
library(tidyverse)
library(randomForest)
library(caret)
```


# Read data and format columns
```{r}
ship <- read.csv("train.csv")

create_base_columns <- function(df){
    df$GID <- as.integer(substr(df$PassengerId, 1,4))
    
    df$IID <- as.integer(substr(df$PassengerId,6,8))
    
    df$GroupSize <- sapply(df$GID, function(x){sum(df$GID == x)})
    
    df$HomePlanet <- as.factor(df$HomePlanet)
    
    df$CryoSleep <- as.logical(df$CryoSleep)
    
    df$Deck <- as.character(mapply(function(x,y){if(nchar(x)==0){NULL}else{substr(x,y[2],y[3]-2)}},
                          df$Cabin,
                          regexec("(.*?)/(.*?)/(.*)", df$Cabin)))
    df$Num <- as.character(mapply(function(x,y){if(nchar(x)==0){NULL}else{substr(x,y[3],y[4]-2)}},
                          df$Cabin,
                          regexec("(.*?)/(.*?)/(.*)", df$Cabin)))
    df$Side <- as.character(mapply(function(x,y){if(nchar(x)==0){NULL}else{substr(x,y[4],nchar(x))}},
                          df$Cabin,
                          regexec("(.*?)/(.*?)/(.*)", df$Cabin)))
    df$Cabin <- sapply(df$Cabin, function(x){if (x=="") NA else x})
    
    df$Destination <- as.factor(df$Destination)
    
    df$Age <- as.integer(df$Age)
    
    df$VIP <- as.logical(df$VIP)
    
    df
}

ship <- create_base_columns(ship)

ship$Transported <- as.logical(ship$Transported)

updateSpending <- function(df){
  rsna <- is.na(df$RoomService)
  fcna <- is.na(df$FoodCourt)
  smna <- is.na(df$ShoppingMall)
  sna <- is.na(df$Spa)
  vrdna <- is.na(df$VRDeck)
  allna <- rsna & fcna & smna & sna & vrdna
  df$Spending <- ifelse(allna, NA, ifelse(rsna, 0, df$RoomService) + ifelse(fcna, 0, df$FoodCourt) + ifelse(smna, 0, df$ShoppingMall) + ifelse(sna, 0, df$Spa) + ifelse(vrdna, 0, df$VRDeck))
  df$HasSpent <- df$Spending > 0
  df
}
ship <- updateSpending(ship)
```


# Fixing missing data
## Change empty strings to NA
```{r}
ship$HomePlanet[ship$HomePlanet==""] <- NA
ship$Destination[ship$Destination==""] <- NA
ship$Name[ship$Name==""] <- NA
```

## Cryosleep implies 0 spending
### Evidence
```{r}
table(ship[ship$CryoSleep %in% T, "HasSpent"])
```
### Update
```{r}
updateSpendingOfCryo <- function(df){
  df[df$CryoSleep %in% T, c("RoomService", "FoodCourt", "ShoppingMall", "Spa", "VRDeck")] <- 0
  df <- updateSpending(df)
  df
}
ship <- updateSpendingOfCryo(ship)
```

## Young children (Age <= 12) don't spend money
### Evidence
```{r}
for (age in 1:15){
  print(paste0(100.0 * nrow(subset(ship, !is.na(Age) & Age==age & !is.na(ship$Spending) & !ship$HasSpent)) / nrow(subset(ship, !is.na(Age) & Age==age & !is.na(ship$Spending))), "% of people age ", age, " have 0 total spending"))
}
```
### Update
```{r}
updateSpendingOfChildren <- function(df){
 df[!is.na(df$Age) & df$Age <= 12, c("RoomService", "FoodCourt", "ShoppingMall", "Spa", "VRDeck")] <- 0
 df <- updateSpending(df)
 df
}
ship <- updateSpendingOfChildren(ship)
```

## Hypothesis: People in the same group of at least 2 members live in the same Deck for cabins A, B, C
### Create Useful Columns
```{r}
updateOthersCabins <- function(df){
    decks <- c("A", "B", "C", "D", "E", "F", "G", "T")

    for (i in 1:nrow(df)){
      group_members <- subset(df, GID == df$GID[i] & IID != df$IID[i])
      for (deck in decks) {
        df[i, paste0("Others", deck)] <- sum(!is.na(group_members$Deck) & group_members$Deck == deck)
      }
      
      df$OthersSameCabin[i] <- ifelse(is.na(df$Cabin[i]),
                               NA,
                               sum(!is.na(group_members$Cabin) & group_members$Cabin == df$Cabin[i]))
      df$OthersNACabin[i] <- sum(is.na(group_members$Cabin))
      df$OthersTransported[i] <- sum(group_members$Transported)
    }
    df
}

ship <- updateOthersCabins(ship)
```

```{r}
gids <- unique(ship$GID[ship$GroupSize > 1])
ship_groups <- data.frame(GID = gids, AllNonNASameCabin = NA, SharedCabin = NA)
ship_groups$UniqueCabins <- 0
ship_groups$NumInSecondCabin <- NA
ship_groups$SharedCabin <- NA
for (i in 1:nrow(ship_groups)){
    gid <- gids[i]
    the_group <- subset(ship, GID == gid)
    ship_groups$CabinNA[i] <- sum(is.na(the_group$Cabin))
    ship_groups$Size[i] <- nrow(the_group)
    if (sum(is.na(the_group$Cabin)) == length(the_group))
        ship_groups$AllNonNASameCabin[i] <- NA
    else{
        unique_cabins <- unique(the_group$Cabin[!is.na(the_group$Cabin)])
        ship_groups$UniqueCabins[i] <- length(unique_cabins)
        ship_groups$AllNonNASameCabin[i] <- length(unique_cabins) == 1
        if (ship_groups$UniqueCabins[i] == 1) {
            ship_groups$SharedCabin[i] <- unique_cabins[1]
        }
        else if (ship_groups$UniqueCabins[i] == 2) {
            num1 <- 0
            num2 <- 0
            for (cabin in the_group$Cabin) {
                if (is.na(cabin)) next
                if (cabin == unique_cabins[1]) num1 <- num1 + 1
                else num2 <- num2 + 1
            }
            ship_groups$NumInSecondCabin[i] <- min(num1, num2)
        }
        else if (ship_groups$UniqueCabins[i] == 3){
            num1 <- 0
            num2 <- 0
            num3 <- 0
            for (cabin in the_group$Cabin) {
                if (is.na(cabin)) next
                if (cabin == unique_cabins[1]) num1 <- num1 + 1
                else if (cabin == unique_cabins[2]) num2 <- num2 + 1
                else num3 <- num3 + 1
            }
            ship_groups$NumInSecondCabin[i] <- sort(c(num1, num2, num3))[2]
        }
        ship_groups$SharedCabin[i] <- ifelse(length(unique_cabins) == 1, unique_cabins[1], NA)
    }
}
```

```{r}
for (i in 2:max(ship_groups$Size)){
    print(paste0("All Non NA Same Cabin (For Groups With Non-NA Size ", i, "):"))
    print(table(ship_groups$AllNonNASameCabin[ship_groups$Size - ship_groups$CabinNA == i & (ship_groups$UniqueCabins == 1 | (ship_groups$UniqueCabins == 2 & ship_groups$NumInSecondCabin == 1))]))
    print("-------------------------------------------")
}

```


##  Spending- vip- Cryosleep:  0%  of people who NOT VIP, but spend some money sleep
### Evidence
```{r}
table(ship$CryoSleep[ship$VIP == F & ship$HasSpent])

```
### Update
```{r}
ship[ship$VIP %in% F & ship$HasSpent, "CryoSleep"] <- F
```


# Models
## Read in Test and Modify
```{r}
test <- read.csv("test.csv")
test <- create_base_columns(test)
test <- updateSpending(test)
test$HomePlanet[test$HomePlanet==""] <- NA
test$Destination[test$Destination==""] <- NA
test$Name[test$Name==""] <- NA
test <- updateSpendingOfCryo(test)
test <- updateSpendingOfChildren(test)
test <- updateOthersCabins(test)
```

## Random Forest
```{r}
library(randomForest)
ship <- rfImpute(ship)
rf <- randomForest(Transported~HomePlanet+CryoSleep+Destination+Age+VIP+Spending+HasSpent+Deck+Side+GroupSize+OthersTransported, data=ship)

```

