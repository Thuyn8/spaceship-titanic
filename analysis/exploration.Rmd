---
title: "exploration"
author: "Jordan Boswell and Thuy Nguyen"
date: "2/26/2022"
output: html_document
---


```{r setup, include=FALSE}
knitr::opts_knit$set(echo = TRUE, root.dir = 'C:/Users/jbos1/Desktop/Projects/Kaggle/spaceship-titanic/data')
```

```{r}
library(randomForest)
library(rpart)
library(rpart.plot)
library(hexbin)
library(tidyverse)
library(grid)
library(dplyr)
```


# Read data and format columns
```{r}
train <- read.csv("train.csv", na.strings=c("NA", ""))
test <- read.csv("test.csv", na.strings=c("NA", ""))
train$Train <- TRUE
test$Train <- FALSE
test$Transported <- NA
ship <- rbind(train, test)

create_base_columns <- function(df){
    df$GID <- as.integer(substr(df$PassengerId, 1,4))
    
    df$IID <- as.integer(substr(df$PassengerId,6,8))
    
    df$GroupSize <- sapply(df$GID, function(x){sum(df$GID == x)})
    
    df$HomePlanet <- as.factor(df$HomePlanet)
    
    df$CryoSleep <- as.logical(df$CryoSleep)
    
    df$Deck <- as.character(sapply(df$Cabin, 
                                   function(x){ifelse(is.na(x), NA, strsplit(x, '/')[[1]][1])}
                                   ))
    df$Num <- as.integer(sapply(df$Cabin, 
                                function(x){ifelse(is.na(x), NA, strsplit(x, '/')[[1]][2])}
                                ))
    df$Side <- as.character(sapply(df$Cabin, 
                                   function(x){ifelse(is.na(x),NA, strsplit(x, '/')[[1]][3])}
                                   ))
    
    df$Destination <- as.factor(df$Destination)
    
    df$Age <- as.integer(df$Age)
    
    df$VIP <- as.logical(df$VIP)
    
    df
}

ship <- create_base_columns(ship)

ship$Transported <- as.logical(ship$Transported)
```

# Add Columns
## Spending
```{r}
updateSpending <- function(df){
  rsna <- is.na(df$RoomService)
  fcna <- is.na(df$FoodCourt)
  smna <- is.na(df$ShoppingMall)
  sna <- is.na(df$Spa)
  vrdna <- is.na(df$VRDeck)
  allna <- rsna & fcna & smna & sna & vrdna
  df$Spending <- ifelse(allna, NA, ifelse(rsna, 0, df$RoomService) + ifelse(fcna, 0, df$FoodCourt) + ifelse(smna, 0, df$ShoppingMall) + ifelse(sna, 0, df$Spa) + ifelse(vrdna, 0, df$VRDeck))
  df$HasSpent <- df$Spending > 0
  df
}
ship <- updateSpending(ship)
```

## Last Name
```{r}
ship$LastName <- sapply(ship$Name, function(x){strsplit(x,split = " ")}[[1]][2])
```

# EDA
## test$GID and train$GID are disjoint
```{r}
intersect(ship$GID[ship$Train], ship$GID[!ship$Train])
```

## CryoSleep iff 0 spending
### Evidence
```{r}
ftable(HasSpent~CryoSleep, data=ship)
```

### Update
```{r}
updateSpendingOfCryo <- function(df){
  df[df$CryoSleep %in% T, c("RoomService", "FoodCourt", "ShoppingMall", "Spa", "VRDeck")] <- 0
  df$CryoSleep[df$HasSpent %in% T] <- F
  df
}
ship <- updateSpendingOfCryo(ship)
```

## Young children (Age <= 12) don't spend money
### Evidence
```{r}
spending_mean <- sapply(split(ship$Spending, ship$Age), mean)
spending_25 <- sapply(split(ship$Spending, ship$Age), function(x){quantile(x, 0.25)})
spending_75 <- sapply(split(ship$Spending, ship$Age), function(x){quantile(x, 0.75)})
spending_length <- sapply(split(ship$Spending, ship$Age), length)

plot(names(spending_mean), spending_mean, main='Spending by Age', xlab='Age', ylab='Spending', col='red', type='l', lwd=2, ylim=c(0, max(spending_75)), xaxp=c(0, 80, 8))
lines(names(spending_mean), spending_25, col='light blue', lwd=2)
lines(names(spending_mean), spending_75, col='dark blue', lwd=2)
barplot(spending_length*15, add=T, space=0, col=rgb(.5,.5,.5,0.07), border=rgb(.5,.5,.5,0.22), names.arg=NA)
abline(v=12, lty=2)
legend(x='topleft', legend=c('75th percentile', 'mean', '25th percentile'), col=c('dark blue', 'red', 'light blue'), lwd=2)

table(as.factor(ifelse(ship$Age <= 12, 1, 0)), ship$HasSpent)
```
### Update
```{r}
updateSpendingOfChildren <- function(df){
 df[!is.na(df$Age) & df$Age <= 12, c("RoomService", "FoodCourt", "ShoppingMall", "Spa", "VRDeck")] <- 0
 df <- updateSpending(df)
 df
}
ship <- updateSpendingOfChildren(ship)
```

## Deck
### Does CryoSleep affect Deck?
#### Distribution of CryoSleep
```{r}
signif(table(ship$Deck[!is.na(ship$CryoSleep) & !is.na(ship$Deck) & ship$CryoSleep == T]) / sum(!is.na(ship$CryoSleep) & !is.na(ship$Deck) & ship$CryoSleep == T) * 100, 4)
```
#### Per-deck percentage of CryoSleep
```{r}
signif(table(ship$Deck[!is.na(ship$CryoSleep) & !is.na(ship$Deck) & ship$CryoSleep == T]) / tapply(ship$Deck, ship$Deck, FUN=length)[-8] * 100, 4)
```

### Exploring Num within each Deck
```{r}
# todo - Change to multi-dist plot (e.g. violin)
for (deck in sort(unique(ship$Deck))){
    if (is.na(deck)) next
    hist(ship$Num[!is.na(ship$Deck) & ship$Deck == deck], main=deck)
}
```
### Other
```{r}
# Average number of people per room (for each deck)
tapply(ship$Num, ship$Deck, function(x){length(x)/length(unique(x))})

tapply(ship$Age, ship$Deck, summary)
```

## Group
### Create Separate Group Dataset
```{r}
gids <- unique(ship$GID[ship$GroupSize > 1])
ship_groups <- data.frame(GID = gids, AllNonNASameCabin = NA, SharedCabin = NA)
ship_groups$UniqueCabins <- 0
ship_groups$NumInSecondCabin <- NA
ship_groups$SharedCabin <- NA
ship_groups$ModeCabin <- NA
ship_groups$HomePlanet <- factor(NA, levels=c("Earth", "Europa", "Mars"))
for (i in 1:nrow(ship_groups)){
    gid <- gids[i]
    the_group <- subset(ship, GID == gid)
    ship_groups$CabinNA[i] <- sum(is.na(the_group$Cabin))
    ship_groups$Size[i] <- nrow(the_group)
    home_planets[i] <- the_group$HomePlanet[!is.na(the_group$HomePlanet)]
    ship_groups$HomePlanets[i] <- length(unique(home_planets))
    ship_groups$HomePlanet[i] <- home_planets[1]
    ship_groups$Destinations[i] <- length(unique(the_group$Destination[!is.na(the_group$Destination)]))
    if (sum(is.na(the_group$Cabin)) == length(the_group))
        ship_groups$AllNonNASameCabin[i] <- NA
    else{
        temp_cabins <- tapply(the_group[!is.na(the_group$Cabin), ], the_group$Cabin[!is.na(the_group$Cabin)], function(x){length(x)})
        ship_groups$ModeCabin <- the_group$Cabin[!is.na(the_group$Cabin)][which.max(temp_cabins)]
        unique_cabins <- unique(the_group$Cabin[!is.na(the_group$Cabin)])
        ship_groups$UniqueCabins[i] <- length(unique_cabins)
        ship_groups$AllNonNASameCabin[i] <- length(unique_cabins) == 1
        if (ship_groups$UniqueCabins[i] == 1) {
            ship_groups$SharedCabin[i] <- unique_cabins[1]
        }
        else if (ship_groups$UniqueCabins[i] == 2) {
            num1 <- 0
            num2 <- 0
            for (cabin in the_group$Cabin) {
                if (is.na(cabin)) next
                if (cabin == unique_cabins[1]) num1 <- num1 + 1
                else num2 <- num2 + 1
            }
            ship_groups$NumInSecondCabin[i] <- min(num1, num2)
        }
        else if (ship_groups$UniqueCabins[i] == 3){
            num1 <- 0
            num2 <- 0
            num3 <- 0
            for (cabin in the_group$Cabin) {
                if (is.na(cabin)) next
                if (cabin == unique_cabins[1]) num1 <- num1 + 1
                else if (cabin == unique_cabins[2]) num2 <- num2 + 1
                else num3 <- num3 + 1
            }
            ship_groups$NumInSecondCabin[i] <- sort(c(num1, num2, num3))[2]
        }
        ship_groups$SharedCabin[i] <- ifelse(length(unique_cabins) == 1, unique_cabins[1], NA)
    }
}

rm(the_group)
rm(home_planets)
rm(temp_cabins)
rm(splits)
```

### Group Columns
```{r, include=FALSE, eval=FALSE}
updateOthersCabins <- function(df){
    decks <- c("A", "B", "C", "D", "E", "F", "G", "T")

    for (i in 1:nrow(df)){
      group_members <- subset(df, GID == df$GID[i] & IID != df$IID[i])
      for (deck in decks) {
        df[i, paste0("Others", deck)] <- sum(!is.na(group_members$Deck) & group_members$Deck == deck)
      }
      
      df$OthersSameCabin[i] <- ifelse(is.na(df$Cabin[i]),
                               NA,
                               sum(!is.na(group_members$Cabin) & group_members$Cabin == df$Cabin[i]))
      df$OthersNACabin[i] <- sum(is.na(group_members$Cabin))
      df$OthersTransported[i] <- sum(group_members$Transported)
    }
    df
}

ship <- updateOthersCabins(ship)
```

## Cabin
### Impute Cabin Based on Group Cabin Mode
#### Evidence - If a person has a group that is all in the same cabin, then should we expect that person to also be in that same cabin?
```{r}
for (i in 2:max(ship_groups$Size)){
    print(paste0("All Non NA Same Cabin (For Groups With Non-NA Size ", i, "):"))
    s <- ship_groups[ship_groups$Size - ship_groups$CabinNA == i & (ship_groups$UniqueCabins == 1 | (ship_groups$UniqueCabins == 2 & ship_groups$NumInSecondCabin == 1)),]
    st <- table(s$AllNonNASameCabin)
    print(st)
    num_true <- ifelse('TRUE' %in% names(st), st[['TRUE']], 0)
    num_false <- ifelse('FALSE' %in% names(st), st[['FALSE']], 0)
    p_same <- i * num_true / (i*num_true + num_false)
    print(paste0('Probability of same cabin: ', round(p_same,2)))
    print("-------------------------------------------")
}
```

#### Update
```{r}
    
```

### Create Separate Cabin Dataset
```{r}
splits <- split(ship[!is.na(ship$Cabin), ], ship$Cabin[!is.na(ship$Cabin)])
ship_cabins <- data.frame(t(
    sapply(splits, function(x){c(
        CabinSize = length(x$PassengerId),
        Cabin = x$Cabin[1],
        Deck = x$Deck[1],
        Side = x$Side[1],
        Num = x$Num[1],
        CabinNumTransported = sum(x$Transported, na.rm=T),
        CabinNumNotTransported = sum(x$Transported==FALSE, na.rm=T),
        CabinTransportedPct = sum(x$Transported == T, na.rm=T)/sum(!is.na(x$Transported)),
        CabinNumCryo = sum(x$CryoSleep, na.rm=T)
    )})
))
ship_cabins$CabinSize <- as.integer(ship_cabins$CabinSize)
ship_cabins$CabinNumTransported <- as.integer(ship_cabins$CabinNumTransported)
ship_cabins$CabinNumNotTransported <- as.integer(ship_cabins$CabinNumNotTransported)
ship_cabins$CabinTransportedPct <- as.numeric(ship_cabins$CabinTransportedPct)
ship_cabins$CabinNumCryo <- as.integer(ship_cabins$CabinNumCryo)
ship_cabins$SideNeighbors <- NA
ship_cabins$SideNeighborsTransported <- NA
ship_cabins$SideNeighborsTransportedPct <- NA
ship_cabins$FrontNeighbors <- NA
ship_cabins$FrontNeighborsTransported <- NA
ship_cabins$FrontNeighborsTransportedPct <- NA
ship_cabins$BackNeighbors <- NA
ship_cabins$BackNeighborsTransported <- NA
ship_cabins$BackNeighborsTransportedPct <- NA
ship_cabins$DiagFrontNeighbors <- NA
ship_cabins$DiagFrontNeighborsTransported <- NA
ship_cabins$DiagFrontNeighborsTransportedPct <- NA
ship_cabins$DiagBackNeighbors <- NA
ship_cabins$DiagBackNeighborsTransported <- NA
ship_cabins$DiagBackNeighborsTransportedPct <- NA
for (i in 1:nrow(ship_cabins)){
    side_neighbor <- subset(ship_cabins, Deck == ship_cabins$Deck[i] & Num == Num[i] & Side != Side[i])
    back_neighbor <- subset(ship_cabins, Deck == ship_cabins$Deck[i] & Num == Num[i]-1 & Side == Side[i])
    front_neighbor <- subset(ship_cabins, Deck == ship_cabins$Deck[i] & Num == Num[i]+1 & Side == Side[i])
    diag_back_neighbor <- subset(ship_cabins, Deck == ship_cabins$Deck[i] & Num == Num[i]-1 & Side != Side[i])
    diag_front_neighbor <- subset(ship_cabins, Deck == ship_cabins$Deck[i] & Num == Num[i]+1 & Side != Side[i])
    ship_cabins$SideNeighborsNonNA[i] <- ifelse(nrow(side_neighbor) == 0, 0, side_neighbor$CabinNumTransported + side_neighbor$CabinNumNotTransported)
    ship_cabins$SideNeighborsTransported[i] <- ifelse(nrow(side_neighbor) == 0, 0, side_neighbor$CabinNumTransported)
    ship_cabins$SideNeighborsTransportedPct[i] <- ifelse(nrow(side_neighbor) == 0, 0, side_neighbor$CabinTransportedPct)
    ship_cabins$FrontNeighborsNonNA[i] <- ifelse(nrow(front_neighbor) == 0, 0, front_neighbor$CabinNumTransported + front_neighbor$CabinNumNotTransported)
    ship_cabins$FrontNeighborsTransported[i] <- ifelse(nrow(front_neighbor) == 0, 0, front_neighbor$CabinNumTransported)
    ship_cabins$FrontNeighborsTransportedPct[i] <- ifelse(nrow(front_neighbor) == 0, 0, front_neighbor$CabinTransportedPct)
    ship_cabins$BackNeighborsNonNA[i] <- ifelse(nrow(back_neighbor) == 0, 0, back_neighbor$CabinNumTransported + back_neighbor$CabinNumNotTransported)
    ship_cabins$BackNeighborsTransported[i] <- ifelse(nrow(back_neighbor) == 0, 0, back_neighbor$CabinNumTransported)
    ship_cabins$BackNeighborsTransportedPct[i] <- ifelse(nrow(back_neighbor) == 0, 0, back_neighbor$CabinTransportedPct)
    ship_cabins$DiagFrontNeighborsNonNA[i] <- ifelse(nrow(diag_front_neighbor) == 0, 0, diag_front_neighbor$CabinNumTransported + diag_front_neighbor$CabinNumNotTransported)
    ship_cabins$DiagFrontNeighborsTransported[i] <- ifelse(nrow(diag_front_neighbor) == 0, 0, diag_front_neighbor$CabinNumTransported)
    ship_cabins$DiagFrontNeighborsTransportedPct[i] <- ifelse(nrow(diag_front_neighbor) == 0, 0, diag_front_neighbor$CabinTransportedPct)
    ship_cabins$DiagBackNeighborsNonNA[i] <- ifelse(nrow(diag_back_neighbor) == 0, 0, diag_back_neighbor$CabinNumTransported + diag_back_neighbor$CabinNumNotTransported)
    ship_cabins$DiagBackNeighborsTransported[i] <- ifelse(nrow(diag_back_neighbor) == 0, 0, diag_back_neighbor$CabinNumTransported)
    ship_cabins$DiagBackNeighborsTransportedPct[i] <- ifelse(nrow(diag_back_neighbor) == 0, 0, diag_back_neighbor$CabinTransportedPct)
rm(splits)
}
```

### Add Cabin Columns
```{r}
ship <- merge(ship, ship_cabins, by=c('Cabin', 'Side', 'Deck', 'Num'), all.x=T)
```

### Other
#### Percentage of Cabins Having the Same CryoSleep

```{r}
count <- 0
total <- 0
for (i in unique(ship$Cabin[!is.na(ship$Cabin)])){
  g <- ship[!is.na(ship$CryoSleep) & !is.na(ship$Cabin) & ship$Cabin == i, ]
  if (nrow(g) <= 1) next
  if (length(unique(g$CryoSleep)) == 1) {
    count <- count + 1
    total <- total + 1
  }
  else if (length(unique(g$CryoSleep)) == 2) {
    total <- total + 1
  }
}
print(paste0(count, " / ", total, " = ", round(count/total, 2)))
```

### Groups Share the Same HomePlanet (But Not Destination)
#### Evidence
```{r}
table(ship_groups$HomePlanets)
table(ship_groups$Destinations)
```

#### Update
```{r}
for (i in 1:nrow(ship)){
    if (is.na(ship$HomePlanet[i]) && ship$GroupSize[i] > 1){
        ship$HomePlanet[i] <- ship_groups$HomePlanet[ship_groups$GID == ship$GID[i]]
    }
}
```

#  How many groups is each last name a part of?
```{r, }
lastnames <- unique(ship$LastName[!is.na(ship$LastName)])
num_people <- vector(mode='integer', length=length(lastnames))
num_groups <- vector(mode='integer', length=length(lastnames))

for (i in 1:length(lastnames)) {
    lastname_subset <- ship$GID[!is.na(ship$LastName) & ship$LastName == lastnames[i]]
    num_people[i] <- length(lastname_subset)
    num_groups[i] <- length(unique(lastname_subset))
}
'print(summary(num_people/num_groups))'
```

# Same last name,same group !-> same cabin
```{r}
data <- ship %>% filter(!is.na(LastName) & !is.na(Cabin))

for(i in unique(data$LastName)){
  Name <- subset(data, LastName == i)
  if (nrow(Name) ==1)
    next
  
  else if (length(unique(Name$GID)>1)) 
     {
    for (j in unique(Name$GID)){
      gid <- subset(Name, GID ==j)
     
      if (nrow(gid) ==1)
        next
     
      else if (length(unique(gid$Cabin)) >1)
    
          print(gid$GID)
    }
  }
}
```

## Heat-maps

```{r}
heatarray <- function(c1, c2){
  train <- subset(ship, Train == T)
  c1 <- as.factor(train[[c1]])
  c2 <- as.factor(train[[c2]])
  m <- matrix(NA, nrow = length(levels(c1)), ncol = length(levels(c2)))
  rownames(m) <- levels(c1)
  colnames(m) <- levels(c2)
  for (i in 1:nrow(m)){
    for (j in 1:ncol(m)){
      m[i,j] <- round(sum(train$Transported[c1==levels(c1)[i] & c2==levels(c2)[j]], na.rm=T) / length(train$Transported[!is.na(c1) & !is.na(c2) & c1==levels(c1)[i] & c2==levels(c2)[j]]), 2)
    }
  }
  return(m)
}
```


## percentage of group/lastname/family having the same CryoSleep value

```{r}
count <- 0
total <- 0
for (i in unique(ship$GID)){
  g <- ship[!is.na(ship$CryoSleep) & ship$GID == i & ship$GroupSize > 1, ]
  if (length(unique(g$CryoSleep)) == 1) {
    count <- count + 1
    total <- total + 1
  }
  else if (length(unique(g$CryoSleep)) == 2) {
    total <- total + 1
  }
}
print(paste0(count, " / ", total, " = ", round(count/total, 2)))
```

```{r}
count <- 0
total <- 0
for (i in unique(ship$LastName)){
  g <- ship[!is.na(ship$CryoSleep) & !is.na(ship$LastName) & ship$LastName == i, ]
  if (length(unique(g$CryoSleep)) == 1) {
    count <- count + 1
    total <- total + 1
  }
  else if (length(unique(g$CryoSleep)) == 2) {
    total <- total + 1
  }
}
print(paste0(count, " / ", total, " = ", round(count/total, 2)))
```

```{r}
count <- 0
total <- 0
for (i in unique(ship$GID)){
  g <- ship[!is.na(ship$CryoSleep) & ship$GID == i & ship$GroupSize > 1, ]
  for (j in unique(g$LastName[!is.na(g$LastName)])){
    g2 <- g[!is.na(g$LastName) & g$LastName == j, ]
    if (length(unique(g2$CryoSleep)) == 1) {
      count <- count + 1
      total <- total + 1
    }
    else if (length(unique(g2$CryoSleep)) == 2) {
      total <- total + 1
    }
  }
}
print(paste0(count, " / ", total, " = ", round(count/total, 2)))
```

```{r}
library(corrplot)

shipCor <- ship[, c('Age', 'RoomService', 'FoodCourt', 'ShoppingMall', 'Spa', 'VRDeck', 'Transported', 'GroupSize', 'Num', 'Spending')]
shipCor$CryoSleep <- as.numeric(ship$CryoSleep)
shipCor$VIP <- as.numeric(ship$VIP)
shipCor$Side <- ifelse(ship$Side == 'S', 1, 0)

pcorr <- cor.mtest(shipCor, conf.level=0.95)
corrplot(cor(shipCor, use='pairwise.complete.obs'), p.mat=pcorr$p, sig.level=0.10)
```
```{r}
train <- subset(ship, Deck == 'D' & Train==T)
hb <- hexbin(train[['Spa']], train[['FoodCourt']], IDs=T)
hvp <- plot(hb, colramp=function(n, beg=1, end=92){LinGray(n, 1, 1)}, border='white', clip="off")
pushHexport(hvp$plot.vp)
ht <- hexTapply(hb, train$Transported, FUN=function(x){(sum(x)/length(x))*100})
hb_count <- hb@count
hb@count <- as.integer(ht)
grid.hexagons(hb, colramp=LinGray, border='white')
    
loess_fit <- loess(hb@ycm ~ hb@xcm, weights = hb_count, span = .4)
pseq <- seq(hb@xbnds[1]+1, hb@xbnds[2]-1, length = 100)
grid.lines(pseq, predict(loess_fit,pseq), gp = gpar(col = 2, lwd=2.5), default.units = "native")
```